<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Databáze zvukových materiálů českého filmu</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #ffffff;
            color: #333333;
            line-height: 1.6;
        }

        .header {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px 20px;
        }

        .header-top {
            display: flex;
            align-items: flex-start;
            gap: 30px;
            margin-bottom: 30px;
        }

        .logo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 15px;
            font-size: 12px;
            line-height: 1.4;
            color: #333;
            flex-shrink: 0;
        }

        .logo-text {
            font-weight: 500;
        }

        .header-content {
            flex: 1;
        }

        h1 {
            font-size: 2.5em;
            font-weight: 300;
            color: #333;
            margin-bottom: 20px;
        }

        .nav-tabs {
            display: flex;
            gap: 30px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 30px;
        }

        .nav-tab {
            padding: 10px 0;
            background: none;
            border: none;
            font-size: 16px;
            color: #666;
            cursor: pointer;
            position: relative;
            font-family: inherit;
        }

        .nav-tab.active {
            color: #8b5cf6;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: #8b5cf6;
        }

        .nav-tab:hover {
            color: #8b5cf6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px 40px;
        }

        .search-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .search-controls-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            font-size: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #f9f9f9;
            transition: border-color 0.3s, background 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #8b5cf6;
            background: #fff;
        }

        .sort-select {
            padding: 12px 16px;
            font-size: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #f9f9f9;
            color: #333;
            cursor: pointer;
            transition: border-color 0.3s, background 0.3s;
            min-width: 250px;
        }

        .sort-select:focus {
            outline: none;
            border-color: #8b5cf6;
            background: #fff;
        }

        .sort-direction {
            padding: 12px 16px;
            font-size: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #f9f9f9;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sort-direction:hover {
            background: #f5f5f5;
            border-color: #8b5cf6;
        }

        .sort-direction-icon {
            font-size: 0.9em;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .pagination-button {
            padding: 8px 16px;
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.2s;
        }

        .pagination-button:hover:not(:disabled) {
            background: #e9e9e9;
        }

        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-numbers {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .pagination-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.2s;
        }

        .pagination-number:hover {
            background: #f5f5f5;
        }

        .pagination-number.active {
            background: #8b5cf6;
            color: white;
        }

        .films-list {
            background: white;
        }

        .film-row {
            border-bottom: 1px solid #e0e0e0;
            padding: 20px 0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .film-row:hover {
            background: #fafafa;
        }

        .film-row:last-child {
            border-bottom: none;
        }

        .film-row.expanded {
            background: #fafafa;
        }

        .film-main-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .film-title {
            font-size: 1.1em;
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }

        .film-meta {
            display: flex;
            gap: 30px;
            font-size: 0.95em;
            color: #666;
        }

        .film-count {
            color: #666;
        }

        .expand-icon {
            font-size: 0.9em;
            color: #8b5cf6;
            transition: transform 0.3s;
        }

        .film-row.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .film-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            margin-top: 20px;
        }

        .film-row.expanded .film-details {
            max-height: 5000px;
            transition: max-height 0.5s ease-in;
        }

        .materials-container {
            padding: 10px 0;
        }

        .display-options-toggle {
            background: none;
            border: 1px solid #e0e0e0;
            padding: 12px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .display-options-toggle:hover {
            background: #f5f5f5;
            border-color: #8b5cf6;
        }

        .display-options-panel {
            display: none;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
        }

        .display-options-panel.active {
            display: block;
        }

        .display-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .display-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .display-option input[type="checkbox"] {
            cursor: pointer;
        }

        .display-option label {
            cursor: pointer;
            font-size: 0.9em;
            color: #333;
            user-select: none;
        }

        .filter-panel {
            display: none;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
        }

        .filter-panel.active {
            display: block;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 0.9em;
            font-weight: 500;
            color: #333;
        }

        .filter-select {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #fff;
            color: #333;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        .filter-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 8px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }

        .filter-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-checkbox-item input[type="checkbox"] {
            cursor: pointer;
        }

        .filter-checkbox-item label {
            cursor: pointer;
            font-size: 0.9em;
            color: #333;
            user-select: none;
        }

        .filter-mode {
            display: flex;
            gap: 15px;
            margin-top: 8px;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .filter-mode-option {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-mode-option input[type="radio"] {
            cursor: pointer;
        }

        .filter-mode-option label {
            cursor: pointer;
            font-size: 0.85em;
            color: #666;
            user-select: none;
        }

        .material-group {
            border-bottom: 1px solid #e0e0e0;
            padding: 8px 0;
            font-size: 0.9em;
        }

        .material-group:last-child {
            border-bottom: none;
        }

        .material-group-main {
            display: flex;
            align-items: center;
            gap: 25px;
            color: #333;
            line-height: 1.5;
        }

        .material-group-sub {
            display: flex;
            align-items: center;
            gap: 25px;
            color: #666;
            line-height: 1.5;
            padding-left: 30px;
            margin-top: 4px;
            font-size: 0.9em;
        }

        .material-name {
            font-weight: 500;
            min-width: 180px;
            flex-shrink: 0;
            color: #333;
        }

        .material-name-sub {
            font-weight: 400;
            min-width: 180px;
            flex-shrink: 0;
            color: #666;
        }

        .material-info {
            display: flex;
            gap: 25px;
            color: #666;
            flex-wrap: wrap;
            flex: 1;
        }

        .material-info-item {
            display: flex;
            gap: 6px;
            align-items: baseline;
        }

        .material-info-label {
            color: #999;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            font-size: 16px;
        }

        .stats {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div class="logo">
                <div class="logo-text">Národní<br>filmový<br>archiv</div>
            </div>
            <div class="header-content">
                <h1>Katalog filmů a materiálů</h1>
                <div class="nav-tabs">
                    <button class="nav-tab active">Filmy</button>
                    <button class="nav-tab">Materiály</button>
                    <button class="nav-tab">O katalogu</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="search-controls">
            <div class="search-controls-row">
                <input type="text" id="searchBox" class="search-box" placeholder="Hledat...">
                <select id="sortSelect" class="sort-select">
                    <option value="alphabetical">Řadit dle abecedy</option>
                    <option value="material-count">Řadit dle počtu materiálů</option>
                    <option value="material-diversity">Řadit dle rozmanitosti materiálů</option>
                    <option value="date">Řadit dle data</option>
                </select>
                <button class="sort-direction" id="sortDirection" onclick="toggleSortDirection()">
                    <span class="sort-direction-icon" id="sortDirectionIcon">↑</span>
                    <span id="sortDirectionText">Vzestupně</span>
                </button>
                <button class="display-options-toggle" onclick="toggleDisplayOptions('global-display-options')">
                    Možnosti zobrazení
                </button>
                <button class="display-options-toggle" onclick="toggleDisplayOptions('filter-panel')">
                    Filtry
                </button>
            </div>
            <div class="display-options-panel" id="global-display-options">
                <div class="display-options-grid" id="display-options-grid">
                    <!-- Dynamicky vygenerováno -->
                </div>
            </div>
            <div class="filter-panel" id="filter-panel">
                <div class="filter-grid" id="filter-grid">
                    <!-- Dynamicky vygenerováno -->
                </div>
            </div>
        </div>

        <div class="pagination" id="pagination" style="display: none;">
            <button class="pagination-button" id="prevBtn" onclick="changePage(-1)">Předchozí</button>
            <div class="pagination-numbers" id="pageNumbers"></div>
            <button class="pagination-button" id="nextBtn" onclick="changePage(1)">Další</button>
        </div>

        <div id="loading" class="loading">Načítání dat...</div>
        <div id="films-container" class="films-list"></div>
    </div>

    <script>
        let filmsData = [];
        let filteredFilms = [];
        let currentPage = 1;
        let currentSort = 'alphabetical';
        let sortAscending = true;
        const itemsPerPage = 20;
        
        // Nastavení zobrazení materiálů
        let displayOptions = {
            content: false,
            language: false,
            secondary: false,
            tertiary: false
        };

        // Načtení a parsování CSV
        async function loadCSV() {
            try {
                // Zkusit načíst z lokálního souboru, pokud selže, použít raw GitLab URL
                const localUrl = 'unique_normalized_titles_ais - final.csv';
                const gitlabRawUrl = 'https://git.digilab.nfa.cz/jonas.kucharsky/databaze-zvukovych-materialu/-/raw/main/public/unique_normalized_titles_ais%20-%20final.csv';
                
                let response;
                let text;
                
                // Zkusit lokální soubor
                try {
                    response = await fetch(localUrl);
                    if (!response.ok) throw new Error('Local file not found');
                    text = await response.text();
                } catch (localError) {
                    // Pokud lokální načtení selže, použít raw GitLab URL
                    console.log('Lokální soubor nenalezen, načítám z GitLabu...');
                    response = await fetch(gitlabRawUrl);
                    if (!response.ok) throw new Error('GitLab file not found');
                    text = await response.text();
                }
                const lines = text.split('\n');
                
                // Parsování hlavičky
                const headers = lines[0].split(',').map(h => h.trim());
                
                // Parsování řádků
                const rows = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    // Jednoduchý CSV parser (zvládne základní případy)
                    const row = parseCSVLine(lines[i]);
                    if (row.length === headers.length) {
                        const obj = {};
                        headers.forEach((header, idx) => {
                            obj[header] = row[idx] || '';
                        });
                        rows.push(obj);
                    }
                }

                // Seskupení podle normalizovaného názvu (gpt_ais)
                const filmsMap = {};
                rows.forEach(row => {
                    const filmTitle = row['gpt_ais'] || row['normed'] || 'Bez názvu';
                    if (!filmsMap[filmTitle]) {
                        filmsMap[filmTitle] = [];
                    }
                    filmsMap[filmTitle].push(row);
                });

                // Převod na pole a extrakce roku z dat
                filmsData = Object.keys(filmsMap).map(title => {
                    const materials = filmsMap[title];
                    // Pokus o extrakci roku z dat (např. z "ozvučen dne")
                    const years = new Set();
                    const dates = [];
                    materials.forEach(m => {
                        const dateStr = m['ozvučen dne'] || '';
                        const yearMatch = dateStr.match(/\d{4}/);
                        if (yearMatch) {
                            years.add(yearMatch[0]);
                        }
                        // Parsování data pro řazení
                        if (dateStr.trim() && dateStr !== '-') {
                            // Formát: DD.MM.YYYY nebo DD/MM/YYYY
                            const dateMatch = dateStr.match(/(\d{1,2})[./](\d{1,2})[./](\d{4})/);
                            if (dateMatch) {
                                const day = parseInt(dateMatch[1]);
                                const month = parseInt(dateMatch[2]);
                                const year = parseInt(dateMatch[3]);
                                const date = new Date(year, month - 1, day);
                                if (!isNaN(date.getTime())) {
                                    dates.push(date.getTime());
                                }
                            }
                        }
                    });
                    const yearStr = Array.from(years).sort().join(', ');
                    
                    // Výpočet rozmanitosti materiálů (počet různých recording_technical_cs)
                    const materialTypes = new Set();
                    materials.forEach(m => {
                        const techRecord = m['recording_technical_cs'] || '';
                        const key = techRecord.trim() || '—';
                        materialTypes.add(key);
                    });
                    
                    // Nejstarší a nejnovější datum
                    const earliestDate = dates.length > 0 ? Math.min(...dates) : null;
                    const latestDate = dates.length > 0 ? Math.max(...dates) : null;
                    
                    return {
                        title: title,
                        materials: materials,
                        year: yearStr || '—',
                        materialCount: materials.length,
                        materialDiversity: materialTypes.size,
                        earliestDate: earliestDate,
                        latestDate: latestDate
                    };
                });

                // Analýza dostupných sloupců a hodnot
                analyzeDataAndCreateUI(rows);
                
                // Aplikace výchozího řazení
                sortFilms();
                filteredFilms = [...filmsData];
                currentPage = 1;
                renderFilms();
                updatePagination();
                
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Chyba při načítání CSV:', error);
                document.getElementById('loading').textContent = 'Chyba při načítání dat: ' + error.message;
            }
        }

        // Jednoduchý CSV parser
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }

        // Funkce pro řazení filmů
        function sortFilms() {
            const direction = sortAscending ? 1 : -1;
            
            switch(currentSort) {
                case 'alphabetical':
                    filmsData.sort((a, b) => {
                        const result = a.title.localeCompare(b.title, 'cs');
                        return result * direction;
                    });
                    break;
                case 'material-count':
                    filmsData.sort((a, b) => {
                        if (b.materialCount !== a.materialCount) {
                            return (b.materialCount - a.materialCount) * direction;
                        }
                        return a.title.localeCompare(b.title, 'cs');
                    });
                    break;
                case 'material-diversity':
                    filmsData.sort((a, b) => {
                        if (b.materialDiversity !== a.materialDiversity) {
                            return (b.materialDiversity - a.materialDiversity) * direction;
                        }
                        return a.title.localeCompare(b.title, 'cs');
                    });
                    break;
                case 'date':
                    filmsData.sort((a, b) => {
                        // Použijeme nejstarší datum, pokud není, pak nejnovější
                        const dateA = a.earliestDate || a.latestDate || 0;
                        const dateB = b.earliestDate || b.latestDate || 0;
                        
                        if (dateA !== dateB) {
                            return (dateA - dateB) * direction;
                        }
                        return a.title.localeCompare(b.title, 'cs');
                    });
                    break;
            }
        }
        
        // Funkce pro přepínání směru řazení
        function toggleSortDirection() {
            sortAscending = !sortAscending;
            updateSortDirectionUI();
            sortFilms();
            applyFilters();
        }
        
        // Aktualizace UI pro směr řazení
        function updateSortDirectionUI() {
            const icon = document.getElementById('sortDirectionIcon');
            const text = document.getElementById('sortDirectionText');
            if (icon && text) {
                icon.textContent = sortAscending ? '↑' : '↓';
                text.textContent = sortAscending ? 'Vzestupně' : 'Sestupně';
            }
        }

        // Analýza dat a dynamické vytváření UI
        function analyzeDataAndCreateUI(rows) {
            // Mapování sloupců na jejich hodnoty
            const columnValues = {};
            const columnHasData = {};
            
            // Analyzovat všechny řádky
            rows.forEach(row => {
                Object.keys(row).forEach(column => {
                    if (!columnValues[column]) {
                        columnValues[column] = new Set();
                        columnHasData[column] = false;
                    }
                    
                    const value = row[column] || '';
                    const trimmedValue = value.trim();
                    
                    // Zkontrolovat, zda sloupec má data (ne prázdné, ne "-", ne "—", ne "#N/A")
                    if (trimmedValue && trimmedValue !== '-' && trimmedValue !== '—' && trimmedValue !== '[neurčeno]' && trimmedValue !== '#N/A') {
                        columnHasData[column] = true;
                        columnValues[column].add(trimmedValue);
                    }
                });
            });
            
            // Vytvořit možnosti zobrazení pro recording_* sloupce
            const displayOptionsGrid = document.getElementById('display-options-grid');
            displayOptionsGrid.innerHTML = '';
            
            const recordingColumns = Object.keys(columnHasData).filter(col => 
                col.startsWith('recording_') && columnHasData[col]
            );
            
            // Reset displayOptions
            displayOptions = {};
            
            recordingColumns.forEach(column => {
                const key = column.replace('recording_', '').replace('_cs', '');
                displayOptions[key] = false;
                
                const optionDiv = document.createElement('div');
                optionDiv.className = 'display-option';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `display-${key}`;
                checkbox.onchange = () => updateDisplayOption(key, checkbox.checked);
                
                const label = document.createElement('label');
                label.htmlFor = `display-${key}`;
                label.textContent = `${getColumnLabel(column)} (${column})`;
                
                optionDiv.appendChild(checkbox);
                optionDiv.appendChild(label);
                displayOptionsGrid.appendChild(optionDiv);
            });
            
            // Vytvořit filtry pro sloupce s daty
            const filterGrid = document.getElementById('filter-grid');
            filterGrid.innerHTML = '';
            
            // Sloupce pro filtry (můžeme přidat další podle potřeby)
            const filterColumns = [
                'recording_content_cs',
                'recording_technical_cs',
                'zvukař_cleaned',
                'formát',
                'typ materiálu',
                'recording_secondary_cs',
                'recording_tertiary_cs',
                'recording_language'
            ];
            
            filterColumns.forEach(column => {
                if (columnHasData[column] && columnValues[column].size > 0) {
                    const filterGroup = document.createElement('div');
                    filterGroup.className = 'filter-group';
                    
                    const label = document.createElement('label');
                    label.className = 'filter-label';
                    label.htmlFor = `filter-${column.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    label.textContent = getColumnLabel(column);
                    
                    // Speciální zpracování pro recording_content_cs - checkboxy místo selectu
                    if (column === 'recording_content_cs') {
                        // Rozdělit hodnoty podle středníku a získat unikátní kategorie
                        const categories = new Set();
                        columnValues[column].forEach(value => {
                            const parts = value.split(';').map(p => p.trim()).filter(p => p);
                            parts.forEach(part => categories.add(part));
                        });
                        
                        const checkboxesContainer = document.createElement('div');
                        checkboxesContainer.className = 'filter-checkboxes';
                        checkboxesContainer.id = `filter-${column.replace(/[^a-zA-Z0-9]/g, '-')}`;
                        checkboxesContainer.dataset.column = column;
                        
                        Array.from(categories).sort().forEach(category => {
                            const checkboxItem = document.createElement('div');
                            checkboxItem.className = 'filter-checkbox-item';
                            
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.id = `filter-content-${category.replace(/[^a-zA-Z0-9]/g, '-')}`;
                            checkbox.value = category;
                            checkbox.onchange = () => applyFilters();
                            
                            const checkboxLabel = document.createElement('label');
                            checkboxLabel.htmlFor = checkbox.id;
                            checkboxLabel.textContent = category;
                            
                            checkboxItem.appendChild(checkbox);
                            checkboxItem.appendChild(checkboxLabel);
                            checkboxesContainer.appendChild(checkboxItem);
                        });
                        
                        // Přidat možnost výběru režimu filtrování
                        const modeContainer = document.createElement('div');
                        modeContainer.className = 'filter-mode';
                        
                        const modeLabel = document.createElement('div');
                        modeLabel.style.fontSize = '0.85em';
                        modeLabel.style.color = '#666';
                        modeLabel.style.marginBottom = '4px';
                        modeLabel.textContent = 'Režim filtrování:';
                        
                        const modeOptions = document.createElement('div');
                        modeOptions.style.display = 'flex';
                        modeOptions.style.gap = '15px';
                        
                        const singleMaterialMode = document.createElement('div');
                        singleMaterialMode.className = 'filter-mode-option';
                        const radio1 = document.createElement('input');
                        radio1.type = 'radio';
                        radio1.name = 'content-filter-mode';
                        radio1.id = 'content-filter-mode-single';
                        radio1.value = 'single';
                        radio1.checked = true;
                        radio1.onchange = () => applyFilters();
                        const label1 = document.createElement('label');
                        label1.htmlFor = 'content-filter-mode-single';
                        label1.textContent = 'V jednom materiálu';
                        singleMaterialMode.appendChild(radio1);
                        singleMaterialMode.appendChild(label1);
                        
                        const acrossFilmMode = document.createElement('div');
                        acrossFilmMode.className = 'filter-mode-option';
                        const radio2 = document.createElement('input');
                        radio2.type = 'radio';
                        radio2.name = 'content-filter-mode';
                        radio2.id = 'content-filter-mode-across';
                        radio2.value = 'across';
                        radio2.onchange = () => applyFilters();
                        const label2 = document.createElement('label');
                        label2.htmlFor = 'content-filter-mode-across';
                        label2.textContent = 'Napříč filmem';
                        acrossFilmMode.appendChild(radio2);
                        acrossFilmMode.appendChild(label2);
                        
                        modeOptions.appendChild(singleMaterialMode);
                        modeOptions.appendChild(acrossFilmMode);
                        modeContainer.appendChild(modeOptions);
                        
                        filterGroup.appendChild(label);
                        filterGroup.appendChild(checkboxesContainer);
                        filterGroup.appendChild(modeContainer);
                    } else {
                        // Ostatní sloupce - normální select
                        const select = document.createElement('select');
                        select.id = `filter-${column.replace(/[^a-zA-Z0-9]/g, '-')}`;
                        select.className = 'filter-select';
                        select.dataset.column = column;
                        select.onchange = () => applyFilters();
                        
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = 'Všechny';
                        select.appendChild(defaultOption);
                        
                        Array.from(columnValues[column]).sort().forEach(value => {
                            const option = document.createElement('option');
                            option.value = value;
                            option.textContent = value;
                            select.appendChild(option);
                        });
                        
                        filterGroup.appendChild(label);
                        filterGroup.appendChild(select);
                    }
                    
                    filterGrid.appendChild(filterGroup);
                }
            });
        }
        
        // Pomocná funkce pro získání popisku sloupce
        function getColumnLabel(column) {
            const labels = {
                'recording_content_cs': 'Obsah',
                'recording_technical_cs': 'Typ',
                'recording_secondary_cs': 'Sekundární typ',
                'recording_tertiary_cs': 'Terciární typ',
                'recording_language': 'Jazyk',
                'zvukař_cleaned': 'Zvukař',
                'formát': 'Formát',
                'typ materiálu': 'Typ materiálu'
            };
            return labels[column] || column;
        }
        
        // Aplikace filtrů a vyhledávání
        function applyFilters() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            // Získat všechny aktivní filtry
            const activeFilters = {};
            
            // Zpracovat normální selecty
            document.querySelectorAll('.filter-select').forEach(select => {
                if (select.value) {
                    const originalColumn = select.dataset.column;
                    activeFilters[originalColumn] = select.value;
                }
            });
            
            // Zpracovat checkboxy pro obsah
            const contentCheckboxes = document.querySelectorAll('#filter-recording-content-cs input[type="checkbox"]:checked');
            const selectedCategories = Array.from(contentCheckboxes).map(cb => cb.value);
            const contentFilterMode = document.querySelector('input[name="content-filter-mode"]:checked')?.value || 'single';
            
            if (selectedCategories.length > 0) {
                activeFilters['recording_content_cs'] = {
                    categories: selectedCategories,
                    mode: contentFilterMode
                };
            }
            
            filteredFilms = filmsData.filter(film => {
                // Textové vyhledávání
                let matchesSearch = true;
                if (searchTerm) {
                    matchesSearch = film.title.toLowerCase().includes(searchTerm) ||
                        film.year.toLowerCase().includes(searchTerm) ||
                        film.materials.some(m => 
                            Object.values(m).some(val => 
                                val && val.toString().toLowerCase().includes(searchTerm)
                            )
                        );
                }
                
                if (!matchesSearch) return false;
                
                // Aplikovat všechny aktivní filtry
                for (const [column, filterValue] of Object.entries(activeFilters)) {
                    if (column === 'recording_content_cs' && typeof filterValue === 'object') {
                        // Speciální zpracování pro obsah s checkboxy
                        const { categories, mode } = filterValue;
                        
                        if (mode === 'single') {
                            // Hledat v jednom konkrétním materiálu (hodnoty oddělené středníkem)
                            const hasMatch = film.materials.some(m => {
                                const value = m[column] || '';
                                const valueParts = value.split(';').map(p => p.trim()).filter(p => p);
                                // Zkontrolovat, zda všechny vybrané kategorie jsou v tomto materiálu
                                return categories.every(cat => valueParts.includes(cat));
                            });
                            if (!hasMatch) return false;
                        } else {
                            // Hledat napříč filmem (všechny hodnoty u daného titulu)
                            const allContentValues = new Set();
                            film.materials.forEach(m => {
                                const value = m[column] || '';
                                const valueParts = value.split(';').map(p => p.trim()).filter(p => p);
                                valueParts.forEach(part => allContentValues.add(part));
                            });
                            // Zkontrolovat, zda všechny vybrané kategorie jsou v nějakém materiálu filmu
                            const hasAllCategories = categories.every(cat => allContentValues.has(cat));
                            if (!hasAllCategories) return false;
                        }
                    } else {
                        // Normální filtr (select)
                        const hasValue = film.materials.some(m => {
                            const value = m[column] || '';
                            return value.trim() === filterValue;
                        });
                        if (!hasValue) return false;
                    }
                }
                
                return true;
            });
            
            currentPage = 1;
            renderFilms();
            updatePagination();
        }
        
        // Vyhledávání
        document.getElementById('searchBox').addEventListener('input', () => {
            applyFilters();
        });

        // Řazení
        document.getElementById('sortSelect').addEventListener('change', (e) => {
            currentSort = e.target.value;
            sortFilms();
            applyFilters();
        });

        // Stránkování
        function updatePagination() {
            const totalPages = Math.ceil(filteredFilms.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            
            // Tlačítko Předchozí
            document.getElementById('prevBtn').disabled = currentPage === 1;
            
            // Tlačítko Další
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
            
            // Čísla stránek
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';
            
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            if (startPage > 1) {
                const num = document.createElement('div');
                num.className = 'pagination-number';
                num.textContent = '1';
                num.onclick = () => goToPage(1);
                pageNumbers.appendChild(num);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('div');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '0 8px';
                    pageNumbers.appendChild(ellipsis);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const num = document.createElement('div');
                num.className = 'pagination-number' + (i === currentPage ? ' active' : '');
                num.textContent = i;
                num.onclick = () => goToPage(i);
                pageNumbers.appendChild(num);
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('div');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '0 8px';
                    pageNumbers.appendChild(ellipsis);
                }
                
                const num = document.createElement('div');
                num.className = 'pagination-number';
                num.textContent = totalPages;
                num.onclick = () => goToPage(totalPages);
                pageNumbers.appendChild(num);
            }
        }

        function goToPage(page) {
            currentPage = page;
            renderFilms();
            updatePagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function changePage(delta) {
            const totalPages = Math.ceil(filteredFilms.length / itemsPerPage);
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                goToPage(newPage);
            }
        }

        // Renderování filmů
        function renderFilms() {
            const container = document.getElementById('films-container');
            
            if (filteredFilms.length === 0) {
                container.innerHTML = '<div class="loading">Žádné filmy nenalezeny</div>';
                return;
            }

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const filmsToShow = filteredFilms.slice(startIndex, endIndex);

            container.innerHTML = filmsToShow.map((film, index) => {
                const globalIndex = startIndex + index;
                const materialCount = film.materials.length;
                const materialText = materialCount === 1 ? 'materiál' : materialCount < 5 ? 'materiály' : 'materiálů';
                
                return `
                    <div class="film-row" data-index="${globalIndex}">
                        <div class="film-main-info" onclick="toggleFilm(${globalIndex})">
                            <div>
                                <div class="film-title">${escapeHtml(film.title)}</div>
                                <div class="film-meta">
                                    <span>${escapeHtml(film.year)}</span>
                                    <span class="film-count">${materialCount} ${materialText}</span>
                                </div>
                            </div>
                            <span class="expand-icon">▼</span>
                        </div>
                        <div class="film-details">
                            <div class="materials-container">
                                ${renderMaterialGroups(film.materials, globalIndex)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Seskupení a renderování materiálů podle recording_technical_cs
        function renderMaterialGroups(materials, filmIndex) {
            // Seskupení podle recording_technical_cs
            const groups = {};
            
            materials.forEach(material => {
                const techRecord = material['recording_technical_cs'] || '';
                const key = techRecord.trim() || '—';
                
                if (!groups[key]) {
                    groups[key] = {
                        name: key,
                        materials: [],
                        formats: new Set(),
                        parts: new Set()
                    };
                }
                
                groups[key].materials.push(material);
                
                // Přidání formátu
                const format = material['formát'] || '';
                if (format.trim() && format !== '-') {
                    groups[key].formats.add(format.trim());
                }
                
                // Přidání dílu
                const part = material['díl'] || '';
                if (part.trim() && part !== '-') {
                    const parts = part.split(/[;,]/).map(p => p.trim()).filter(p => p);
                    parts.forEach(p => groups[key].parts.add(p));
                }
            });
            
            // Převod na pole a seřazení
            const groupArray = Object.values(groups).sort((a, b) => {
                if (a.name === '—') return 1;
                if (b.name === '—') return -1;
                return a.name.localeCompare(b.name, 'cs');
            });
            
            if (groupArray.length === 0) {
                return '<div class="material-group"><div class="material-group-main">Žádné materiály</div></div>';
            }
            
            const groupsHtml = groupArray.map(group => {
                const partsArray = Array.from(group.parts).sort((a, b) => {
                    const numA = parseInt(a);
                    const numB = parseInt(b);
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return numA - numB;
                    }
                    return a.localeCompare(b, 'cs');
                });
                
                const partsStr = partsArray.length > 0 ? partsArray.join(', ') : '—';
                const formatsArray = Array.from(group.formats);
                const formatStr = formatsArray.length > 0 ? formatsArray.join(', ') : '—';
                const count = group.materials.length;
                
                // Hlavní řádek
                let html = `
                    <div class="material-group">
                        <div class="material-group-main">
                            <div class="material-name">${escapeHtml(group.name)}</div>
                            <div class="material-info">
                                <div class="material-info-item">
                                    <span class="material-info-label">díly:</span>
                                    <span>${escapeHtml(partsStr)}</span>
                                </div>
                                <div class="material-info-item">
                                    <span class="material-info-label">počet:</span>
                                    <span>${count}</span>
                                </div>
                                <div class="material-info-item">
                                    <span class="material-info-label">formát:</span>
                                    <span>${escapeHtml(formatStr)}</span>
                                </div>
                            </div>
                        </div>
                `;
                
                // Dodatečné řádky podle nastavení - dynamicky pro všechny recording_* sloupce
                Object.keys(displayOptions).forEach(key => {
                    if (displayOptions[key]) {
                        // Mapování klíče na název sloupce
                        const columnName = `recording_${key}_cs`;
                        const columnLabel = getColumnLabel(columnName);
                        
                        // Získat hodnoty pro tento sloupec z materiálů této skupiny
                        const values = new Set();
                        group.materials.forEach(m => {
                            const value = m[columnName] || '';
                            if (value && value.trim() && value.trim() !== '-' && value.trim() !== '—' && value.trim() !== '[neurčeno]' && value.trim() !== '#N/A') {
                                values.add(value.trim());
                            }
                        });
                        
                        if (values.size > 0) {
                            const valuesArray = Array.from(values).sort();
                            const valuesStr = valuesArray.join(', ');
                            html += `
                                <div class="material-group-sub">
                                    <div class="material-name-sub">${columnLabel}:</div>
                                    <div class="material-info">
                                        <span>${escapeHtml(valuesStr)}</span>
                                    </div>
                                </div>
                            `;
                        }
                    }
                });
                
                html += '</div>';
                return html;
            }).join('');
            
            return groupsHtml;
        }
        
        // Funkce pro přepínání zobrazení možností
        function toggleDisplayOptions(panelId) {
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.toggle('active');
            }
        }
        
        // Funkce pro aktualizaci nastavení zobrazení
        function updateDisplayOption(option, value) {
            displayOptions[option] = value;
            // Znovu renderovat všechny rozbalené filmy
            document.querySelectorAll('.film-row.expanded').forEach(row => {
                const index = row.getAttribute('data-index');
                if (index !== null) {
                    const idx = parseInt(index);
                    if (idx >= 0 && idx < filteredFilms.length) {
                        const film = filteredFilms[idx];
                        if (film) {
                            const detailsContainer = row.querySelector('.materials-container');
                            if (detailsContainer) {
                                detailsContainer.innerHTML = renderMaterialGroups(film.materials, idx);
                            }
                        }
                    }
                }
            });
        }

        // Přepínání rozbalení filmu
        function toggleFilm(index) {
            const filmRow = document.querySelector(`[data-index="${index}"]`);
            if (filmRow) {
                filmRow.classList.toggle('expanded');
            }
        }

        // Escape HTML pro bezpečnost
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Inicializace checkboxů
        function initializeDisplayOptions() {
            // Dynamicky inicializovat všechny checkboxy podle displayOptions
            Object.keys(displayOptions).forEach(key => {
                const checkbox = document.getElementById(`display-${key}`);
                if (checkbox) {
                    checkbox.checked = displayOptions[key];
                }
            });
            updateSortDirectionUI();
        }

        // Načtení dat při načtení stránky
        loadCSV();
        // Inicializace checkboxů po načtení DOM
        document.addEventListener('DOMContentLoaded', initializeDisplayOptions);
        // Také zavolat ihned, pokud je DOM už načtený
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDisplayOptions);
        } else {
            initializeDisplayOptions();
        }
    </script>
</body>
</html>

